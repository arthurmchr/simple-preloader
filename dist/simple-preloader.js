!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t.SimplePreloader=e()}}(function(){return function e(t,r,n){function o(a,s){if(!r[a]){if(!t[a]){var l="function"==typeof require&&require;if(!s&&l)return l(a,!0);if(i)return i(a,!0);var u=new Error("Cannot find module '"+a+"'");throw u.code="MODULE_NOT_FOUND",u}var d=r[a]={exports:{}};t[a][0].call(d.exports,function(e){var r=t[a][1][e];return o(r?r:e)},d,d.exports,e,t,r,n)}return r[a].exports}for(var i="function"==typeof require&&require,a=0;a<n.length;a++)o(n[a]);return o}({1:[function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var o=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=t.concurent,o=void 0===r?6:r,i=t.onComplete,a=void 0===i?null:i,s=t.onFileLoaded,l=void 0===s?null:s,u=t.onProgress,d=void 0===u?null:u;n(this,e),this.xhrFunc=this.xhrFunc.bind(this),this._concurent=o,this._onComplete=a,this._onFileLoaded=l,this._onProgress=d,this._queue=[],this._group=null,this._totalProgress=0,this._totalSize=0,this._inlineBlob=URL.createObjectURL(new Blob(["self.addEventListener('message', (event)=> {\n\n	if (event.data.type === 'start') {\n\n		self.xhr = new XMLHttpRequest();\n		self.xhr.open('GET', event.data.el.url);\n		self.xhr.responseType = event.data.type === 'json' ? 'json' : 'arraybuffer';\n\n		self.xhr.onload = ()=> {\n\n			if (self.xhr.readyState === self.xhr.DONE) {\n\n				if (self.xhr.status === 200) {\n\n					self.postMessage({\n						type: 'onload',\n						res: event.data.type === 'json' ? self.xhr.responseText : self.xhr.response,\n						el: event.data.el\n					});\n				}\n			}\n\n			close();\n		};\n\n		self.xhr.onprogress = (eventProgress)=> {\n\n			self.postMessage({\n				type: 'onprogress',\n				progress: eventProgress.loaded / eventProgress.total,\n				el: event.data.el\n			});\n		};\n\n		self.xhr.send();\n	}\n	else if (event.data.type === 'stop') {\n\n		self.xhr.abort();\n		close();\n	}\n});\n"],{type:"application/javascript"}))}return o(e,[{key:"add",value:function(e){if(Array.isArray(e)){var t=!0,r=!1,n=void 0;try{for(var o,i=e[Symbol.iterator]();!(t=(o=i.next()).done);t=!0){var a=o.value;this.addToQueue(a)}}catch(s){r=!0,n=s}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}}else this.addToQueue(e);return this}},{key:"addToQueue",value:function(e){var t=void 0;if(t="string"==typeof e?{url:e}:e,t.id||(t.id=t.url),!t.type){var r=t.url.split(".");t.type=r.length>1?r.pop():null}t.isLoading=!1,t.totalSize=0,t.blobUrl=null,this._queue.push(t)}},{key:"start",value:function(e,t){e&&(this._onComplete=e),this._group=t,this.getHeaders(t),this.startDownload(t)}},{key:"isFileLoaded",value:function(e){if(Array.isArray(e)){var t=!0,r=!1,n=void 0;try{for(var o,i=e[Symbol.iterator]();!(t=(o=i.next()).done);t=!0){var a=o.value;if(!this.getResult(a.id||a.url||a))return!1}}catch(s){r=!0,n=s}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}}return this.getResult(e.id||e.url||e)?!0:!1}},{key:"getHeaders",value:function(e){var t=this;this._totalSize=0;var r=!0,n=!1,o=void 0;try{for(var i,a=function(){var e=i.value;if(e.blobUrl||e.totalSize)return"continue";var r=new XMLHttpRequest;r.open("HEAD",e.url),r.onload=function(){e.totalSize=r.getResponseHeader("Content-Length"),t._totalSize+=e.totalSize},r.send()},s=this.getGroupQueue(e)[Symbol.iterator]();!(r=(i=s.next()).done);r=!0)a()}catch(l){n=!0,o=l}finally{try{!r&&s["return"]&&s["return"]()}finally{if(n)throw o}}}},{key:"getGroupQueue",value:function(e){return e?this._queue.filter(this.filterByGroup(e)):this._queue}},{key:"filterByGroup",value:function(e){return function(t){return t.group===e}}},{key:"startDownload",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this._concurent,r=this.getGroupQueue(e),n=t,o=0;o<r.length;o++){var i=r[o];if(!i.isLoading&&!i.blobUrl){var a=new Worker(this._inlineBlob);if(a.addEventListener("message",this.xhrFunc),i.isLoading=!0,i.worker=a,a.postMessage({type:"start",el:{id:i.id,url:i.url,type:i.type}}),n--,0===n)return}}}},{key:"xhrFunc",value:function(e){var t=this.getElById(e.data.el.id);switch(e.data.type){case"onload":this._totalProgress+=t.totalSize,this.fileLoadedHandler(e.data.res,t);break;case"onprogress":this._onProgress&&this._onProgress(this._totalProgress+e.data.progress,this._totalSize)}}},{key:"getElById",value:function(e){var t=!0,r=!1,n=void 0;try{for(var o,i=this._queue[Symbol.iterator]();!(t=(o=i.next()).done);t=!0){var a=o.value;if(a.id===e)return a}}catch(s){r=!0,n=s}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}}},{key:"fileLoadedHandler",value:function(e,t){if(t.worker.terminate(),t.isLoading=!1,"json"===t.type)t.blobUrl=event.data.res;else{var r="";switch(t.type){case"jpg":r="image/jpeg";break;case"png":r="image/png";break;case"mp3":r="audio/mpeg";break;case"webm":r="video/webm";break;case"mp4":r="video/mp4"}t.blobUrl=URL.createObjectURL(new Blob([event.data.res],{type:r}))}this._onFileLoaded&&this._onFileLoaded(t);var n=this.getStatus(this._group);n.notStarted?this.startDownload(this._group,1):0===n.notStarted&&0===n.notFinished&&this._onComplete&&this._onComplete()}},{key:"getStatus",value:function(e){var t=0,r=0,n=!0,o=!1,i=void 0;try{for(var a,s=this.getGroupQueue(e)[Symbol.iterator]();!(n=(a=s.next()).done);n=!0){var l=a.value;l.isLoading||l.blobUrl?l.isLoading&&r++:t++}}catch(u){o=!0,i=u}finally{try{!n&&s["return"]&&s["return"]()}finally{if(o)throw i}}return{notStarted:t,notFinished:r}}},{key:"stop",value:function(){var e=!0,t=!1,r=void 0;try{for(var n,o=this._queue[Symbol.iterator]();!(e=(n=o.next()).done);e=!0){var i=n.value;i.isLoading&&(i.worker.postMessage({type:"stop"}),i.worker.terminate(),i.isLoading=!1)}}catch(a){t=!0,r=a}finally{try{!e&&o["return"]&&o["return"]()}finally{if(t)throw r}}}},{key:"getResult",value:function(e){return this.getElById(e).blobUrl}},{key:"revoke",value:function(e,t){var r=!0,n=!1,o=void 0;try{for(var i,a=this._queue[Symbol.iterator]();!(r=(i=a.next()).done);r=!0){var s=i.value;if(!(e&&s.id!==e||t&&s.group!==t))if(s.blobUrl&&"json"!==s.type){if(e)return window.URL.revokeObjectURL(s.blobUrl);window.URL.revokeObjectURL(s.blobUrl)}else if(e)return}}catch(l){n=!0,o=l}finally{try{!r&&a["return"]&&a["return"]()}finally{if(n)throw o}}}},{key:"destroy",value:function(){this.stop(),this.revoke()}},{key:"onFileLoaded",set:function(e){this._onFileLoaded=e}},{key:"onProgress",set:function(e){this._onProgress=e}}]),e}();r["default"]=i},{}]},{},[1])(1)});
//# sourceMappingURL=simple-preloader.js.map