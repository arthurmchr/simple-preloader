!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t.SimplePreloader=e()}}(function(){return function e(t,r,n){function o(i,s){if(!r[i]){if(!t[i]){var l="function"==typeof require&&require;if(!s&&l)return l(i,!0);if(a)return a(i,!0);var u=new Error("Cannot find module '"+i+"'");throw u.code="MODULE_NOT_FOUND",u}var f=r[i]={exports:{}};t[i][0].call(f.exports,function(e){var r=t[i][1][e];return o(r?r:e)},f,f.exports,e,t,r,n)}return r[i].exports}for(var a="function"==typeof require&&require,i=0;i<n.length;i++)o(n[i]);return o}({1:[function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var o=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=t.concurent,o=void 0===r?6:r,a=t.headers,i=void 0===a?!1:a,s=t.onComplete,l=void 0===s?null:s,u=t.onProgress,f=void 0===u?null:u;n(this,e),this.xhrFunc=this.xhrFunc.bind(this),this._concurent=o,this._headers=i,this._onComplete=l,this._onProgress=f,this._queue=[],this._group=null,this._inlineBlob=URL.createObjectURL(new Blob(["self.addEventListener('message', (event)=> {\n\n	if (event.data.type === 'start') {\n\n		self.xhr = new XMLHttpRequest();\n		self.xhr.open('GET', event.data.el.url);\n		self.xhr.responseType = event.data.type === 'json' ? 'json' : 'arraybuffer';\n\n		self.xhr.onload = ()=> {\n\n			if (self.xhr.readyState === self.xhr.DONE) {\n\n				if (self.xhr.status === 200) {\n\n					self.postMessage({\n						type: 'onload',\n						res: event.data.type === 'json' ? self.xhr.responseText : self.xhr.response,\n						el: event.data.el\n					});\n				}\n			}\n\n			close();\n		};\n\n		self.xhr.onprogress = (eventProgress)=> {\n\n			self.postMessage({\n				type: 'onprogress',\n				progress: {\n					loaded: eventProgress.loaded,\n					total: eventProgress.total,\n					val: eventProgress.loaded / eventProgress.total\n				},\n				el: event.data.el\n			});\n		};\n\n		self.xhr.send();\n	}\n	else if (event.data.type === 'stop') {\n\n		self.xhr.abort();\n		close();\n	}\n});\n"],{type:"application/javascript"}))}return o(e,[{key:"add",value:function(e){if(Array.isArray(e)){var t=!0,r=!1,n=void 0;try{for(var o,a=e[Symbol.iterator]();!(t=(o=a.next()).done);t=!0){var i=o.value;this.addToQueue(i)}}catch(s){r=!0,n=s}finally{try{!t&&a["return"]&&a["return"]()}finally{if(r)throw n}}}else this.addToQueue(e)}},{key:"addToQueue",value:function(e){var t=void 0;if(t="string"==typeof e?{url:e}:e,t.id||(t.id=t.url),!t.type){var r=t.url.split(".");t.type=r.length>1?r.pop():null}t.isLoading=!1,t.progress=null,t.totalSize=0,t.blobUrl=null,this._queue.push(t)}},{key:"start",value:function(e){this._group=e,this._headers&&this.getHeaders(e),this.startDownload(e)}},{key:"getHeaders",value:function(e){var t=!0,r=!1,n=void 0;try{for(var o,a=function(){var e=o.value;if(e.blobUrl||e.totalSize)return"continue";var t=new XMLHttpRequest;t.open("HEAD",e.url),t.onload=function(){e.totalSize=t.getResponseHeader("Content-Length")},t.send()},i=this.getGroupQueue(e)[Symbol.iterator]();!(t=(o=i.next()).done);t=!0)a()}catch(s){r=!0,n=s}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}}},{key:"getGroupQueue",value:function(e){return e?this._queue.filter(this.filterByGroup(e)):this._queue}},{key:"filterByGroup",value:function(e){return function(t){return t.group===e}}},{key:"startDownload",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this._concurent,r=this.getGroupQueue(e),n=t,o=0;o<r.length;o++){var a=r[o];if(!a.isLoading&&!a.blobUrl){var i=new Worker(this._inlineBlob);if(i.addEventListener("message",this.xhrFunc),a.isLoading=!0,a.worker=i,i.postMessage({type:"start",el:{id:a.id,url:a.url,type:a.type}}),n--,0===n)return}}}},{key:"xhrFunc",value:function(e){var t=this.getElById(e.data.el.id);switch(e.data.type){case"onload":this.fileLoadedHandler(e.data.res,t);break;case"onprogress":t.progress=e.data.progress,this._onProgress&&this._onProgress(e.data.progress)}}},{key:"getElById",value:function(e){var t=!0,r=!1,n=void 0;try{for(var o,a=this._queue[Symbol.iterator]();!(t=(o=a.next()).done);t=!0){var i=o.value;if(i.id===e)return i}}catch(s){r=!0,n=s}finally{try{!t&&a["return"]&&a["return"]()}finally{if(r)throw n}}}},{key:"fileLoadedHandler",value:function(e,t){if(t.worker.terminate(),t.isLoading=!1,"json"===t.type)t.blobUrl=event.data.res;else{var r="";switch(t.type){case"jpg":r="image/jpeg";break;case"png":r="image/png";break;case"mp3":r="audio/mpeg";break;case"webm":r="video/webm";break;case"mp4":r="video/mp4"}t.blobUrl=URL.createObjectURL(new Blob([event.data.res],{type:r}))}var n=this.getStatus(this._group);n.notStarted?this.startDownload(this._group,1):0===n.notStarted&&0===n.notFinished&&this._onComplete&&this._onComplete()}},{key:"getStatus",value:function(e){var t=0,r=0,n=!0,o=!1,a=void 0;try{for(var i,s=this.getGroupQueue(e)[Symbol.iterator]();!(n=(i=s.next()).done);n=!0){var l=i.value;l.isLoading||l.blobUrl?l.isLoading&&r++:t++}}catch(u){o=!0,a=u}finally{try{!n&&s["return"]&&s["return"]()}finally{if(o)throw a}}return{notStarted:t,notFinished:r}}},{key:"stop",value:function(){var e=!0,t=!1,r=void 0;try{for(var n,o=this._queue[Symbol.iterator]();!(e=(n=o.next()).done);e=!0){var a=n.value;a.isLoading&&(a.worker.postMessage({type:"stop"}),a.worker.terminate(),a.isLoading=!1,a.progress=null)}}catch(i){t=!0,r=i}finally{try{!e&&o["return"]&&o["return"]()}finally{if(t)throw r}}}},{key:"getResult",value:function(e){return this.getElById(e).blobUrl}},{key:"revoke",value:function(e,t){var r=!0,n=!1,o=void 0;try{for(var a,i=this._queue[Symbol.iterator]();!(r=(a=i.next()).done);r=!0){var s=a.value;if(!(e&&s.id!==e||t&&s.group!==t))if(s.blobUrl&&"json"!==s.type){if(e)return window.URL.revokeObjectURL(s.blobUrl);window.URL.revokeObjectURL(s.blobUrl)}else if(e)return}}catch(l){n=!0,o=l}finally{try{!r&&i["return"]&&i["return"]()}finally{if(n)throw o}}}},{key:"destroy",value:function(){this.stop(),this.revoke()}}]),e}();r["default"]=a},{}]},{},[1])(1)});
//# sourceMappingURL=simple-preloader.js.map